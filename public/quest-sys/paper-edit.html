<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>北京师范大学问卷系统--修改问卷</title>

  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="icon" type="image/x-icon" href="images/white-logo.png">
  <link rel="stylesheet" href="http://cdn.static.runoob.com/libs/bootstrap/3.3.7/css/bootstrap.min.css">
  <script src="http://cdn.static.runoob.com/libs/jquery/2.1.1/jquery.min.js"></script>
  <script src="http://cdn.static.runoob.com/libs/bootstrap/3.3.7/js/bootstrap.min.js"></script>
  <script type="text/javascript" src="./js/common.js"></script>
   <link rel="stylesheet" type="text/css" href="./css/default.css">
  <link rel="stylesheet" type="text/css" href="./css/wjxmaster.css">
  <link rel="stylesheet" type="text/css" href="./css/paper-edit.css">
  <!-- <script src="./js/paper-edit.js"></script> -->
 </head>
  
<style>

</style>
<body style="background: #F2F7F9;">
<div style="background: #FFFFFF;" >
		<div id="BS" style="background: #FFFFFF;" >
            </div>
            <script>
                getHeaderHtml();
            </script> 
      </div> 
	</div>

 
<div class="editContent" style="min-width: 1000px;" id="container">
	<!--title -->
	<div class="editTitle">
		<div class="issueName clearfix">
			<div class="issueTitle fl">问卷名称</div>
			<input type="text" class="fl issueInput" name="title" id="title" >
		</div>
		<div class="issueDescribe clearfix">
			<div class="describeTitle fl">问卷描述说明</div>
			<textarea name="desc" id="desc" cols="30" rows="10" class="fl describeTxt"></textarea>
		</div>
		<div class="line"></div>
	</div>


	<div class="editContainer" id="default-editContainer" style="display: none;">
		<div class="block clearfix">
			<div class="build clearfix">
				<select name="" class="issueSelect">
					<option value="0" selected>单选题</option>
					<option value="1">多选题</option>
					<option value="2">问答题</option>
					<option value="3">填空题</option>
					<option value="4">量表题</option>
					<option value="5">下拉框</option>
					<option value="6">文件上传</option>
				</select>
			
		    <div class="Otitle">问题<span>1</span></div>
		    <textarea cols="30" rows="10" class="Otextarea"></textarea>
		    <button class="uploadImg clearfix"><i class="OImg"></i>上传图片</button>
		    <button class="addIssue" id="cloneTopic">＋新增问题</button>
		    <div class="delectIssue" id="removeTopic">删除此问题</div>
			</div>

			<div id="option-container">
				<div class="setName">设置选项</div>
				<div id="option_hidden" class="setOption clearfix" style="display: none;" >
					<input type="text" class="setInput1">
					<button class="uploadImg"><i class="OImg"></i>上传图片</button>
					<button class="addIssue" id="cloneHiddenOption">＋新增选项</button>
					<div class="delectIssue" id="removeHiddenOption">删除此选项</div>
				</div>

			<div id="option-list">
				<div class="setOption clearfix">
					<input type="text" class="setInput1">
					<button class="uploadImg"><i class="OImg"></i>上传图片</button>
		      		<button class="addIssue" id="cloneOption">＋新增选项</button>
		      		<div class="delectIssue" id="removeOption">删除此选项</div>
				</div>
			</div>
			</div>
		</div>
	</div>


<div id="0"></div>


   	 
</div>

</body>
<script type="text/javascript" >

var id = getvl('id');
var topics = new Array();
var topic_index = new Array();

var topic_number = 0;
$(function () {
	getPaper();
});

var upload_target_id;

function getPaper() {
    	$.ajax({
			url: host + '/api/a/getPaper',
			type: "GET",
			dataType: "json", 
			data: {token: token, id: id},
			cache: false,
			success: function(result) {
				if (result.state == 200) {
					$('#title').val(result.data.title);
					$('#desc').val(result.data.desc);
					var htmls = '';
					if(result.data.topics.length == 0) {
						addTopic(0);
					}

					$.each(result.data.topics, function(i, item) {
						var html = '';

						html += '<div class="editContainer" id="' + i + '" style="min-width: 1000px;">';
						html += '<div class="block clearfix">';
						html += '<div class="build clearfix">';

						html += '<select class="issueSelect" name="topicType' + i + "\" onChange='changeType(\"" + i + "option\", \"topicType" + i + "\");' >";

						var selected_0 = '';
						var selected_1 = '';
						var selected_2 = '';
						var selected_3 = '';
						var selected_4 = '';
						var selected_5 = '';
						var selected_6 = '';
						if(item.ttype==0) {
							selected_0 = 'selected';
						} else if(item.ttype==1) {
							selected_1 = 'selected';
						} else if(item.ttype==2) {
							selected_2 = 'selected';
						} else if(item.ttype==3) {
							selected_3 = 'selected';
						} else if(item.ttype==4) {
							selected_4 = 'selected';
						} else if(item.ttype==5) {
							selected_5 = 'selected';
						} else if(item.ttype==6) {
							selected_6 = 'selected';
						}

						html += '<option value="0"' + selected_0 + '>单选题</option>';
						html += '<option value="1"' + selected_1 + '>多选题</option>';
						html += '<option value="2"' + selected_2 + '>问答题</option>';
						html += '<option value="3"' + selected_3 + '>填空题</option>';
						html += '<option value="4"' + selected_4 + '>量表题</option>';
						html += '<option value="5"' + selected_5 + '>下拉框</option>';
						html += '<option value="6"' + selected_6 + '>文件上传</option>';
						html += '</select>';

						html += '<div class="Otitle">问题</div>';
						html += '<textarea id="topicTitle' + i + '" cols="30" rows="10" class="Otextarea" >' + item.tdesc + '</textarea>';
						html += '<button class="uploadImg clearfix"><i class="OImg"></i>上传图片</button>';
						html += '<button class="addIssue" onclick="addTopic(' + i + ');" >＋新增问题</button>';
						html += '<div class="delectIssue" onclick="removeTopic(' + i + ');">删除此问题</div>';
						html += '</div>';


						html += '<div id="' + i + 'option">';
						//hidden start
						if (item.ttype == 0 || item.ttype == 1) {
							html += option_0_title;
							html += '<div id="option_hidden' + i + '"  class="setOption clearfix" style="display: none;" >' +
										'<input type="text" class="setInput1">' +
										'<button class="uploadImg"><i class="OImg"></i>上传图片</button>' +
										'<button class="addIssue" id="clonebtn' + i + '" >＋新增选项</button>' +
										'<div class="delectIssue" id="removebtn' + i + '" >删除此选项</div>' +
									'</div>';
						} else if(item.ttype == 3) {
							html += option_3_title;
							html += '<div id="option_hidden' + i + '"  class="setOption clearfix" style="display: none;" >' +
									'<input type="text" class="setInput1 topic-option-fill-desc">' +
									'<div class="underline"></div>' +
									'<button class="addIssue" id="clonebtn' + i + '" >＋新增选项</button>' +
									'<div class="delectIssue" id="removebtn' + i + '" >删除此选项</div>' +
								'</div>';
						} else if(item.ttype == 4){
							html += option_4_title;
							html += '<div id="option_hidden' + i + '"  class="setOption clearfix" style="display: none;" >' +
									'<input type="text" class="setInput1 topic-option-table">' +
									'<input type="text" class="score topic-option-value">' + 
									'<button class="addIssue" id="clonebtn' + i + '" >＋新增选项</button>' +
									'<div class="delectIssue" id="removebtn' + i + '" >删除此选项</div>' +
								'</div>';
						} else if(item.ttype == 5){
							html += option_5_title;
							html += '<div id="option_hidden' + i + '"  class="setOption clearfix" style="display: none;" >' +
									'<input type="text" class="setInput1">' +
									'<button class="addIssue" id="clonebtn' + i + '" >＋新增选项</button>' +
									'<div class="delectIssue" id="removebtn' + i + '" >删除此选项</div>' +
								'</div>';
						} else if(item.ttype == 6){
							html += option_6_title;
							html += '<div id="option_hidden' + i + '"  class="setOption clearfix" style="display: none;" >' +
									'<input type="text" class="setInput1">' +
									'<button class="uploadImg"><i class="OImg"></i>上传文件</button>' +
									'<button class="addIssue" id="clonebtn' + i + '" >＋新增选项</button>' +
									'<div class="delectIssue" id="removebtn' + i + '" >删除此选项</div>' +
								'</div>';
						}

						if (item.ttype != 2) {
							$.each(item.options, function(p, opItem) {
								html += '<div id="' + i + 'option' + p + '" >';

								if (item.ttype == 0 || item.ttype == 1) {
									html += '<div class="setOption clearfix">';
									html += '<input type="text" class="setInput1" value="' + opItem.odesc + '" >' +
											'<button class="uploadImg"><i class="OImg"></i>上传图片</button>';
								} else if(item.ttype == 3) {

									html += '<div class="setOption clearfix">';
									html += '<input type="text" class="setInput1 topic-option-fill-desc" value="' + opItem.odesc + '" >' +
											'<div class="underline"></div>';
								} else if(item.ttype == 4) {
									html += '<div class="setOption clearfix">';
									html += '<input type="text" class="setInput1 topic-option-table" value="' + opItem.odesc + '" >' +
											'<input type="text" class="score topic-option-value" value="' + opItem.point + '" >';
								} else if(item.ttype == 5) {
									html += '<div class="setOption clearfix">';
									html += '<input type="text" class="setInput1" value="' + opItem.odesc + '" >';
								} else if(item.ttype == 6) {
									html += '<div class="setOption clearfix">';
									html += '<input type="text" class="setInput1" value="' + opItem.odesc + '" >' +
											'<button class="uploadImg"><i class="OImg"></i>上传图片</button>';
								}
								html += '<button class="addIssue" ' + "onclick='cloneOption(\"option_hidden" + i + "\", " + i + ",\"" + i + "option" + p + "\");'" + '  >＋新增选项</button>';
								html += '<div class="delectIssue" ' + "onclick='removeOption(\"" + i + "option" + p + "\");'" + ' >删除此选项</div>';

								html += '</div>';
								html += '</div>';
							});
						}
						
						html += '</div>';
						html += '</div></div>';
						topic_number = i;
						topic_index.push(i);
						htmls += html;
					});
					htmls += '<button class="submit" onclick="savePaper();">确 定</button>';
          			$('#container').append(htmls);
				} else {
					alert(result.data.error);
				}
			},
			error: function(XMLHttpRequest, textStatus, errorThrown) {
												
      		}
		});
	}

var optionNum = 100;
function cloneOption(cloneId, topic_number, targetId) {
	var ophtml = $('#' + cloneId).clone().attr('id', topic_number + 'option' + optionNum).show();
	$(ophtml).find('#clonebtn' + topic_number).attr('id', 'clonebtn' + optionNum);
	$(ophtml).find('#removebtn' + topic_number).attr('id', 'removebtn' + optionNum);
	var oldOptionNum = optionNum;
	$(ophtml).find('#removebtn' + optionNum).click(function(){
		removeOption(topic_number + 'option' + oldOptionNum);
	});
	$(ophtml).find('#clonebtn' + optionNum).click(function(){
		cloneOption('option_hidden' + topic_number, topic_number, topic_number + 'option' + oldOptionNum);
	});
	$('#' + targetId).after(ophtml);
	optionNum = optionNum + 1;
}

function removeOption(id) {
	$('#' + id).remove();
}

function removeTopic(id) {
	if(confirm('确定删除这道问题吗？')) {
		$('#' + id).remove();
		removeTopicIndexToArray(id);
		resetTopicIndex();
	}
}

function addTopic(id) {
	
	topic_number = topic_number + 1;
	var correntIndex = topic_number;
	var topicHtml = $('#default-editContainer').clone().attr('id', topic_number).show();
	
	//todo
	$(topicHtml).find('.Otextarea').attr('id', 'topicTitle' + topic_number);
	$(topicHtml).find('.issueSelect').attr('name', 'topicType' + topic_number);
	$(topicHtml).find('.issueSelect').change(function() {
		changeType(topic_number + 'option', 'topicType' + topic_number);
	});
	$(topicHtml).find('#option-container').attr('id', topic_number + 'option');
	$(topicHtml).find('#option_hidden').attr('id', 'option_hidden' + topic_number);
	$(topicHtml).find('#cloneHiddenOption').attr('id', 'clonebtn' + topic_number);
	$(topicHtml).find('#removeHiddenOption').attr('id', 'removebtn' + topic_number);
	$(topicHtml).find('#option-list').attr('id', topic_number + 'option' + 0);

	$(topicHtml).find('#cloneOption').attr('id', topic_number + 'cloneOption' + 0);
	$(topicHtml).find('#removeOption').attr('id', topic_number + 'removeOption' + 0);

	// alert('option_hidden' + topic_number + '_' + topic_number + '_' + topic_number + "option" + 0);
	$(topicHtml).find('#' + topic_number + 'cloneOption' + 0).click(function() {
		var _tem_number = $(this).attr('id').substring(0,1)
		cloneOption('option_hidden' + _tem_number, _tem_number, _tem_number + "option" + 0);
	});
	$(topicHtml).find('#' + topic_number + 'removeOption' + 0).click(function() {
		removeOption(topic_number + "option" + 0);
	});

	$(topicHtml).find('#cloneTopic').attr('id', topic_number + 'cloneOption');
	$(topicHtml).find('#removeTopic').attr('id', topic_number + 'removeOption');
	$(topicHtml).find('#' + topic_number + 'cloneOption').click(function() {
		addTopic(correntIndex);
	});
	$(topicHtml).find('#' + topic_number + 'removeOption').click(function() {
		removeTopic(correntIndex);
	});
	$('#' + id).after(topicHtml);
	addTopicIndexToArray(id, topic_number);
	resetTopicIndex();
}

function addTopicIndexToArray(currentIndex, newIndex) {
	var newTopicIndexArray = new Array();
	for(var i=0; i<topic_index.length; i++) {
		if(topic_index[i] == currentIndex) {
			newTopicIndexArray.push(topic_index[i]);
			newTopicIndexArray.push(newIndex);
		} else {
			newTopicIndexArray.push(topic_index[i]);
		}
	}
	topic_index = newTopicIndexArray;
}

function removeTopicIndexToArray(currentIndex) {
	var newTopicIndexArray = new Array();
	for(var i=0; i<topic_index.length; i++) {
		if(topic_index[i] != currentIndex) {
			newTopicIndexArray.push(topic_index[i]);
		}
	}
	topic_index = newTopicIndexArray;
}

function changeType(optionId, typeName) {
	var type = $('[name="' + typeName + '"]').val();
	var id = optionId.substring(0, 1);
	var newhtml = '';
	$('#' + optionId).empty();
	if(type == 0 || type == 1) {
		newhtml = option_0_title + option_0;
	} else if(type == 2) {

	} else if(type == 3) {
		newhtml = option_3_title + option_3;
	} else if(type == 4) {
		newhtml = option_4_title + option_4;
	} else if(type == 5) {
		newhtml = option_5_title + option_5;
	} else if(type == 6) {
		newhtml = option_6_title + option_6;
	}
	if(type != 2) {
		$('#' + optionId).append(newhtml);
		$('#' + optionId).find('#option_hidden').attr('id', 'option_hidden' + id);
		$('#' + optionId).find('#cloneHiddenOption').attr('id', 'clonebtn' + id);
		$('#' + optionId).find('#removeHiddenOption').attr('id', 'removebtn' + id);
		$('#' + optionId).find('#option-list').attr('id', id + 'option' + 0);
		cloneOption('option_hidden' + id , id, id + 'option' + 0);
	}
}


function savePaper() {
	var checkin = true;

	var title = $('#title').val();
	if(!title) {
		alert('标题不能为空！');
		return;
	}
	var desc = $('#desc').val();

	for(var i=0; i<topic_index.length; i++) {
		var topicTitle = $('#topicTitle' + topic_index[i]).val();
		var type = $('[name="topicType' + topic_index[i] + '"]').val();
		if(!topicTitle) {
			checkin = false;
			topics = new Array();
			alert('题目不能为空！');
			return;
		}
		var topic = {
			tdesc: topicTitle,
			ttype: type
		}
		if(type==0 || type==1 || type==5 || type==6) {
			var options = new Array();
			var option = $('#' + topic_index[i] + 'option').find('.setInput1');
			$.each(option, function(i, item) {
				if(i>0) {
					if(!item.value) {
						topics = new Array();
						alert('选项文字不能为空！');
						checkin = false;
						return;
					}
					var option = {
						odesc: item.value,
						ocount: 0
					};
					options.push(option);
				}
			});
			topic.options = options;
		} else if(type==3) {
			var options = new Array();
			var option = $('#' + topic_index[i] + 'option').find('.topic-option-fill-desc');
			$.each(option, function(i, item) {
				if(i>0) {
					if(!item.value) {
						topics = new Array();
						checkin = false;;
						alert('填空文字说明不能为空！');
						return 
					}
					var option = {
						odesc: item.value,
						ocount: 0
					};
					options.push(option);
				}
			});
			topic.options = options;
		} else if(type==4) {
			var options = new Array();
			var option = $('#' + topic_index[i] + 'option').find('.topic-option-table');
			var optionVal = $('#' + topic_index[i] + 'option').find('.topic-option-value');
			$.each(option, function(i, item) {
				if(i>0) {
					if(!item.value) {
						topics = new Array();
						checkin = false;;
						alert('填空文字说明不能为空！');
						return
					}
					var option = {
						odesc: item.value,
						point: optionVal[i].value,
						ocount: 0
					};
					options.push(option);
				}
			});
			topic.options = options;
		}
		topics.push(topic);
	}
	
	if(checkin) {
		$.ajax({
		url: host + '/api/a/updatePaperTopic',
		type: "POST",
		dataType: "json",
		data: {token: token, id: id, topic: JSON.stringify(topics), format: 0, title: title, desc: desc},
		cache: false,
		success: function(result) {
			if (result.state == 200) {
				alert('修改成功！');
				location.href='paper-list.html';
			} else {
				alert(result.data.error);
			}
		},
		error: function(XMLHttpRequest, textStatus, errorThrown) {
												
      	}
	});
	}
	
}

function resetTopicIndex() {
	var startIndex = 1;
	for(var i=0; i<topic_index.length; i++) {
		var topicTitle = $('#topicTitle' + topic_index[i]).val();
		var reg = new RegExp("^[0-9]*$");
		var endIndex = 1;
		for(var p=1; p<4; p++) {
			if(topicTitle.length >= p && !reg.test(topicTitle.substring(0, p))){
				endIndex = p-1;
				break;
			}
		}
		$('#topicTitle' + topic_index[i]).val(startIndex + topicTitle.substring(endIndex));
		startIndex++;
	}
}

function importFile(obj){

}

var option_0_title = '<div class="setName">设置选项</div>';
var option_0 = '<div id="option_hidden" class="setOption clearfix" style="display: none;" >' +
					'<input type="text" class="setInput1">' +
					'<button class="uploadImg"><i class="OImg"></i>上传图片</button>' +
					'<button class="addIssue" id="cloneHiddenOption">＋新增问题</button>' +
					'<div class="delectIssue" id="removeHiddenOption">删除此问题</div>' +
				'</div>' +			
				'<div id="option-list">' +
				'</div>';

var option_3_title =  '<div class="setName">填空文字说明</div>';
var option_3 = '<div id="option_hidden" class="setOption clearfix" style="display: none;" >' +
					'<input type="text" class="setInput1 topic-option-fill-desc">' +
					'<div class="underline"></div>' +
					'<button class="addIssue" id="cloneHiddenOption">＋新增问题</button>' +
					'<div class="delectIssue" id="removeHiddenOption">删除此问题</div>' +
				'</div>' +			
				'<div id="option-list">' +
				'</div>';

var option_4_title = '<div class="setName">设置选项<span class="scoreName">分数</span></div>';
var option_4 = '<div id="option_hidden" class="setOption clearfix" style="display: none;" >' +
					'<input type="text" class="setInput1 topic-option-table">' +
					'<input type="text" class="score topic-option-value">' +
					'<button class="addIssue" id="cloneHiddenOption">＋新增问题</button>' +
					'<div class="delectIssue" id="removeHiddenOption">删除此问题</div>' +
				'</div>' +			
				'<div id="option-list">' +
				'</div>';
var option_5_title = '<div class="setName">下拉框选择文字说明</div>';
var option_5 = '<div id="option_hidden" class="setOption clearfix" style="display: none;" >' +
					'<input type="text" class="setInput1">' +
					'<button class="addIssue" id="cloneHiddenOption">＋新增问题</button>' +
					'<div class="delectIssue" id="removeHiddenOption">删除此问题</div>' +
				'</div>' +			
				'<div id="option-list">' +
				'</div>';
var option_6_title = '<div class="setName">上传文件描述</div>';
var option_6 = option_0;
</script>
</html>