<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>北京师范大学问卷系统--修改问卷</title>

  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="icon" type="image/x-icon" href="images/white-logo.png">
  <link rel="stylesheet" href="http://cdn.static.runoob.com/libs/bootstrap/3.3.7/css/bootstrap.min.css">
  <script src="http://cdn.static.runoob.com/libs/jquery/2.1.1/jquery.min.js"></script>
  <script src="http://cdn.static.runoob.com/libs/bootstrap/3.3.7/js/bootstrap.min.js"></script>
  <script type="text/javascript" src="./js/common.js"></script>
   <link rel="stylesheet" type="text/css" href="./css/default.css">
  <link rel="stylesheet" type="text/css" href="./css/wjxmaster.css">
  <link rel="stylesheet" type="text/css" href="./css/paper-edit.css">
  <!-- <script src="./js/paper-edit.js"></script> -->

  <link rel="stylesheet" href="./css/index.css" type="text/css">
  <!-- upload start-->
  <!-- CSS to style the file input field as button and adjust the Bootstrap progress bars -->
  <link rel="stylesheet" href="./css/jquery.fileupload.css">

  <script src="http://libs.baidu.com/jquery/1.10.2/jquery.min.js"></script>
  <!-- The jQuery UI widget factory, can be omitted if jQuery UI is already included -->
  <script src="js/jquery.ui.widget.js"></script>
  <!-- The Load Image plugin is included for the preview images and image resizing functionality -->
  <script src="http://blueimp.github.io/JavaScript-Load-Image/js/load-image.all.min.js"></script>
  <!-- The Canvas to Blob plugin is included for image resizing functionality -->
  <script src="http://blueimp.github.io/JavaScript-Canvas-to-Blob/js/canvas-to-blob.min.js"></script>
  <!-- Bootstrap JS is not required, but included for the responsive demo navigation -->
  <script src="http://netdna.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js"></script>
  <!-- The Iframe Transport is required for browsers without support for XHR file uploads -->
  <script src="js/jquery.iframe-transport.js"></script>
  <!-- The basic File Upload plugin -->
  <script src="js/jquery.fileupload.js"></script>
  <!-- The File Upload processing plugin -->
  <script src="js/jquery.fileupload-process.js"></script>
  <!-- The File Upload image preview & resize plugin -->
  <script src="js/jquery.fileupload-image.js"></script>
  <!-- The File Upload audio preview plugin -->
  <script src="js/jquery.fileupload-audio.js"></script>
  <!-- The File Upload video preview plugin -->
  <script src="js/jquery.fileupload-video.js"></script>
  <!-- The File Upload validation plugin -->
  <script src="js/jquery.fileupload-validate.js"></script>

 </head>
  
<style>

</style>
<body style="background: #F2F7F9;">
<div style="background: #FFFFFF;" >
		<div id="BS" style="background: #FFFFFF;" >
            </div>
            <script>
                getHeaderHtml();
            </script> 
      </div> 
	</div>

 
<div class="editContent" style="min-width: 1000px;" id="container">
	<!--title -->
	<div class="editTitle">
		<div class="issueName clearfix">
			<div class="issueTitle fl">问卷名称</div>
			<input type="text" class="fl issueInput" name="title" id="title" >
		</div>
		<div class="issueDescribe clearfix">
			<div class="describeTitle fl">问卷描述说明</div>
			<textarea name="desc" id="desc" cols="30" rows="10" class="fl describeTxt"></textarea>
		</div>
		<div class="line"></div>
	</div>


	<div class="editContainer" id="default-editContainer" style="display: none;">
		<div class="block clearfix">
			<div class="build clearfix">
				<select name="" class="issueSelect">
					<option value="0" selected>单选题</option>
					<option value="1">多选题</option>
					<option value="2">问答题</option>
					<option value="3">填空题</option>
					<option value="4">量表题</option>
					<option value="5">下拉框</option>
					<option value="6">文件上传</option>
				</select>
			
		    <div class="Otitle">问题</div>
			<textarea cols="30" rows="10" class="Otextarea"></textarea>
			<input type="hidden" class="topicImg" />
		    <button class="uploadImg clearfix topicImgBtn"><i class="OImg"></i>上传图片</button>
		    <button class="addIssue" id="cloneTopic">＋新增问题</button>
		    <div class="delectIssue" id="removeTopic">删除此问题</div>
			</div>

			<div id="option-container">
				<div class="setName">设置选项</div>
				<div id="option_hidden" class="setOption clearfix" style="display: none;" >
					<input type="text" class="setInput1">
					<input type="hidden" class="optionImg" />
					<button class="uploadImg"><i class="OImg"></i>上传图片</button>
					<button class="addIssue" id="cloneHiddenOption">＋新增选项</button>
					<div class="delectIssue" id="removeHiddenOption">删除此选项</div>
				</div>

			<div id="option-list">
				<div class="setOption clearfix">
					<input type="text" class="setInput1">
					<input type="hidden" class="optionImg" id="optionImg" />
					<button class="uploadImg" id="uploadImg" ><i class="OImg"></i>上传图片</button>
		      		<button class="addIssue" id="cloneOption">＋新增选项</button>
		      		<div class="delectIssue" id="removeOption">删除此选项</div>
				</div>
			</div>
			</div>
		</div>
	</div>

<div id="0"></div>	 
</div>




    <div class="popups" id="popups" style="display: none;">
      <div id="uploadForm" class="popbox">
      <div class="closeBox" id="closeBox">×</div>
          <div class="navbar navbar-default navbar-fixed-top"></div>  
          <div class="container"> 
              <br>
              <span class="btn btn-success fileinput-button">
                  <i class="glyphicon glyphicon-plus"></i>
                  <span>选择文件</span>
                 <input id="fileupload" type="file" name="files[]" multiple>
              </span>
              <br>
              <br>
              <div id="progress" class="progress">
                  <div class="progress-bar progress-bar-success"></div>
              </div>
              <div id="files" class="files"></div>
              <br>
          </div>
        </div>
    </div>


  

<script>
	var imgId;
    function hiddenSetting(id) {
        var obj = $("#box");
        obj.remove();
    }

	function uploadFile(id){
		imgId = id;
		$("#popups").show();
	}

     
      $("#closeBox").on("click",function() {
        $('#progress .progress-bar').css(
            'width',
            0 + '%'
        );
        $('#files').empty();
        $("#popups").hide();
     });

    $(function () {
    'use strict';
    var url = host + '/upload',
    
        uploadButton = $('<button/>')
            .addClass('btn btn-primary')
            .prop('disabled', true)
            .text('Processing...')
            .on('click', function () {
                var $this = $(this),
                    data = $this.data();
                $this
                    .off('click')
                    .text('Abort')
                    .on('click', function () {
                        $this.remove();
                        data.abort();
                    });
                data.submit().always(function () {
                    $this.remove();
                });
            });
    $('#fileupload').fileupload({
        url:  host + '/upload',
        dataType: 'json',
        autoUpload: false,
        acceptFileTypes: /(\.|\/)(gif|jpe?g|png)$/i,
        maxFileSize: 999000,
        // Enable image resizing, except for Android and Opera,
        // which actually support image resizing, but fail to
        // send Blob objects via XHR requests:
        disableImageResize: /Android(?!.*Chrome)|Opera/
            .test(window.navigator.userAgent),
        previewMaxWidth: 100,
        previewMaxHeight: 100,
        previewCrop: true
    }).on('fileuploadadd', function (e, data) {
        data.context = $('<div/>').appendTo('#files');
        $.each(data.files, function (index, file) {
            var node = $('<p/>')
                    .append($('<span/>').text(file.name));
            if (!index) {
                node
                    .append('<br>')
                    .append(uploadButton.clone(true).data(data));
            }
            node.appendTo(data.context);
        });
    }).on('fileuploadprocessalways', function (e, data) {
        var index = data.index,
            file = data.files[index],
            node = $(data.context.children()[index]);
        if (file.preview) {
            node
                .prepend('<br>')
                .prepend(file.preview);
        }
        if (file.error) {
            node
                .append('<br>')
                .append($('<span class="text-danger"/>').text(file.error));
        }
        if (index + 1 === data.files.length) {
            data.context.find('button')
                .text('Upload')
                .prop('disabled', !!data.files.error);
        }
    }).on('fileuploadprogressall', function (e, data) {
        var progress = parseInt(data.loaded / data.total * 100, 10);
        $('#progress .progress-bar').css(
            'width',
            progress + '%'
        );
    }).on('fileuploaddone', function (e, data) {
		console.log(data.url + '/' + data.result.files[0].name);
		$('#' + imgId).val(data.url + '/' + data.result.files[0].name);
        $.each(data.result.files, function (index, file) {
            if (file.url) {
                var link = $('<a>')
                    .attr('target', '_blank')
                    .prop('href', file.url);
                $(data.context.children()[index])
                    .wrap(link);
            } else if (file.error) {
                var error = $('<span class="text-danger"/>').text(file.error);
                $(data.context.children()[index])
                    .append('<br>')
                    .append(error);
            }
        });
    }).on('fileuploadfail', function (e, data) {
        $.each(data.files, function (index) {
            var error = $('<span class="text-danger"/>').text('File upload failed.');
            $(data.context.children()[index])
                .append('<br>')
                .append(error);
        });
    }).prop('disabled', !$.support.fileInput)
        .parent().addClass($.support.fileInput ? undefined : 'disabled');
});
</script>
<!-- upload end -->

</body>
<script type="text/javascript" >

var id = getvl('id');
var topics = new Array();
var topic_index = new Array();

var topic_number = 0;
$(function () {
	getPaper();
});

var upload_target_id;

function getPaper() {
    	$.ajax({
			url: host + '/api/a/getPaper',
			type: "GET",
			dataType: "json", 
			data: {token: token, id: id},
			cache: false,
			success: function(result) {
				if (result.state == 200) {
					$('#title').val(result.data.title);
					$('#desc').val(result.data.desc);
					var htmls = '';
					if(result.data.topics.length == 0) {
						addTopic(0);
						topic_index.push(1);
					}

					$.each(result.data.topics, function(i, item) {
						var html = '';

						html += '<div class="editContainer" id="' + i + '" style="min-width: 1000px;">';
						html += '<div class="block clearfix">';
						html += '<div class="build clearfix">';

						html += '<select class="issueSelect" name="topicType' + i + "\" onChange='changeType(\"" + i + "option\", \"topicType" + i + "\");' >";

						var selected_0 = '';
						var selected_1 = '';
						var selected_2 = '';
						var selected_3 = '';
						var selected_4 = '';
						var selected_5 = '';
						var selected_6 = '';
						if(item.ttype==0) {
							selected_0 = 'selected';
						} else if(item.ttype==1) {
							selected_1 = 'selected';
						} else if(item.ttype==2) {
							selected_2 = 'selected';
						} else if(item.ttype==3) {
							selected_3 = 'selected';
						} else if(item.ttype==4) {
							selected_4 = 'selected';
						} else if(item.ttype==5) {
							selected_5 = 'selected';
						} else if(item.ttype==6) {
							selected_6 = 'selected';
						}

						html += '<option value="0"' + selected_0 + '>单选题</option>';
						html += '<option value="1"' + selected_1 + '>多选题</option>';
						html += '<option value="2"' + selected_2 + '>问答题</option>';
						html += '<option value="3"' + selected_3 + '>填空题</option>';
						html += '<option value="4"' + selected_4 + '>量表题</option>';
						html += '<option value="5"' + selected_5 + '>下拉框</option>';
						html += '<option value="6"' + selected_6 + '>文件上传</option>';
						html += '</select>';

						html += '<div class="Otitle">问题</div>';
						html += '<textarea id="topicTitle' + i + '" cols="30" rows="10" class="Otextarea" >' + item.tdesc + '</textarea>';

						//todo
						var timgUrl = '';
						if(item.timg) {
							timgUrl = item.timg;
						}
						html += '<input type="hidden" class="topicImg" id="topicImg' + i + '" value="' + timgUrl + '" />';

						html += '<button class="uploadImg clearfix" ' + "onclick='uploadFile(\"topicImg" + i + "\");'" + ' ><i class="OImg"></i>上传图片</button>';
						html += '<button class="addIssue" onclick="addTopic(' + i + ');" >＋新增问题</button>';
						html += '<div class="delectIssue" onclick="removeTopic(' + i + ');">删除此问题</div>';
						html += '</div>';


						html += '<div id="' + i + 'option">';
						//hidden start
						if (item.ttype == 0 || item.ttype == 1) {
							html += option_0_title;
							html += '<div id="option_hidden' + i + '"  class="setOption clearfix" style="display: none;" >' +
										'<input type="text" class="setInput1">' +

										//todo
										'<input type="hidden" class="optionImg" id="optionImg' + i + '" />' +

										'<button class="uploadImg"><i class="OImg"></i>上传图片</button>' +
										'<button class="addIssue" id="clonebtn' + i + '" >＋新增选项</button>' +
										'<div class="delectIssue" id="removebtn' + i + '" >删除此选项</div>' +
									'</div>';
						} else if(item.ttype == 3) {
							html += option_3_title;
							html += '<div id="option_hidden' + i + '"  class="setOption clearfix" style="display: none;" >' +
									'<input type="text" class="setInput1 topic-option-fill-desc">' +
									'<div class="underline"></div>' +
									'<button class="addIssue" id="clonebtn' + i + '" >＋新增选项</button>' +
									'<div class="delectIssue" id="removebtn' + i + '" >删除此选项</div>' +
								'</div>';
						} else if(item.ttype == 4){
							html += option_4_title;
							html += '<div id="option_hidden' + i + '"  class="setOption clearfix" style="display: none;" >' +
									'<input type="text" class="setInput1 topic-option-table">' +
									'<input type="text" class="score topic-option-value">' + 
									'<button class="addIssue" id="clonebtn' + i + '" >＋新增选项</button>' +
									'<div class="delectIssue" id="removebtn' + i + '" >删除此选项</div>' +
								'</div>';
						} else if(item.ttype == 5){
							html += option_5_title;
							html += '<div id="option_hidden' + i + '"  class="setOption clearfix" style="display: none;" >' +
									'<input type="text" class="setInput1">' +
									'<button class="addIssue" id="clonebtn' + i + '" >＋新增选项</button>' +
									'<div class="delectIssue" id="removebtn' + i + '" >删除此选项</div>' +
								'</div>';
						} else if(item.ttype == 6){
							html += option_6_title;
							html += '<div id="option_hidden' + i + '"  class="setOption clearfix" style="display: none;" >' +
									'<input type="text" class="setInput1">' +
									'<button class="uploadImg"><i class="OImg"></i>上传文件</button>' +
									'<button class="addIssue" id="clonebtn' + i + '" >＋新增选项</button>' +
									'<div class="delectIssue" id="removebtn' + i + '" >删除此选项</div>' +
								'</div>';
						}//hidden end

						if (item.ttype != 2) {
							$.each(item.options, function(p, opItem) {
								html += '<div id="' + i + 'option' + p + '" >';
								//todo
								let oimgUrl = '';
								if(opItem.oimg) {
									oimgUrl = opItem.oimg;
								}
								if (item.ttype == 0 || item.ttype == 1) {
									html += '<div class="setOption clearfix">';
									html += '<input type="text" class="setInput1" value="' + opItem.odesc + '" >' +

									
									'<input type="hidden" class="optionImg" id="' + i + 'optionImg' + p + '" value="' + oimgUrl + '" />' +

											'<button class="uploadImg" ' + "onclick='uploadFile(\"" + i + "optionImg" + p + "\");'" + '><i class="OImg"></i>上传图片</button>';
								} else if(item.ttype == 3) {

									html += '<div class="setOption clearfix">';
									html += '<input type="text" class="setInput1 topic-option-fill-desc" value="' + opItem.odesc + '" >' +
											'<div class="underline"></div>';
								} else if(item.ttype == 4) {
									html += '<div class="setOption clearfix">';
									html += '<input type="text" class="setInput1 topic-option-table" value="' + opItem.odesc + '" >' +
											'<input type="text" class="score topic-option-value" value="' + opItem.point + '" >';
								} else if(item.ttype == 5) {
									html += '<div class="setOption clearfix">';
									html += '<input type="text" class="setInput1" value="' + opItem.odesc + '" >';
								} else if(item.ttype == 6) {
									html += '<div class="setOption clearfix">';
									html += '<input type="text" class="setInput1" value="' + opItem.odesc + '" >' +
											'<button class="uploadImg"><i class="OImg"></i>上传图片</button>';
								}
								html += '<button class="addIssue" ' + "onclick='cloneOption(\"option_hidden" + i + "\", " + i + ",\"" + i + "option" + p + "\");'" + '  >＋新增选项</button>';
								html += '<div class="delectIssue" ' + "onclick='removeOption(\"" + i + "option" + p + "\");'" + ' >删除此选项</div>';

								html += '</div>';
								html += '</div>';
							});
						}
						
						html += '</div>';
						html += '</div></div>';
						topic_number = i;
						topic_index.push(i);
						htmls += html;
					});
					htmls += '<button class="submit" onclick="savePaper();">确 定</button>';
          			$('#container').append(htmls);
				} else {
					alert(result.data.error);
				}
			},
			error: function(XMLHttpRequest, textStatus, errorThrown) {
												
      		}
		});
	}

var optionNum = 100;
function cloneOption(cloneId, topic_number, targetId) {
	var ophtml = $('#' + cloneId).clone().attr('id', topic_number + 'option' + optionNum).show();

	$(ophtml).find('#clonebtn' + topic_number).attr('id', 'clonebtn' + optionNum);
	$(ophtml).find('#removebtn' + topic_number).attr('id', 'removebtn' + optionNum);
	var oldOptionNum = optionNum;

	//tood
	$(ophtml).find('.optionImg').attr('id', 'optionImg' + optionNum);
	$(ophtml).find('.uploadImg').click(function() {
		uploadFile('optionImg' + oldOptionNum);
	});

	$(ophtml).find('#removebtn' + optionNum).click(function() {
		removeOption(topic_number + 'option' + oldOptionNum);
	});
	$(ophtml).find('#clonebtn' + optionNum).click(function() {
		cloneOption('option_hidden' + topic_number, topic_number, topic_number + 'option' + oldOptionNum);
	});
	$('#' + targetId).after(ophtml);
	optionNum = optionNum + 1;
}

function removeOption(id) {
	$('#' + id).remove();
}

function removeTopic(id) {
	if(confirm('确定删除这道问题吗？')) {
		$('#' + id).remove();
		removeTopicIndexToArray(id);
		resetTopicIndex();
	}
}

function addTopic(id) {
	
	topic_number = topic_number + 1;
	var correntIndex = topic_number;
	var topicHtml = $('#default-editContainer').clone().attr('id', topic_number).show();
	
	//todo
	$(topicHtml).find('.topicImg').attr('id', 'topicImg' + topic_number);
	$(topicHtml).find('.topicImgBtn').click(function() {
		uploadFile('topicImg' + topic_number);
	});
	$(topicHtml).find('#optionImg').attr('id', topic_number + 'optionImg' + 0);
	$(topicHtml).find('#uploadImg').attr('id', topic_number + 'uploadImg' + 0);
	$(topicHtml).find('#' + topic_number + 'uploadImg' + 0).click(function() {
		uploadFile(topic_number + 'optionImg' + 0);
	});

	$(topicHtml).find('.Otextarea').attr('id', 'topicTitle' + topic_number);
	$(topicHtml).find('.issueSelect').attr('name', 'topicType' + topic_number);
	$(topicHtml).find('.issueSelect').change(function() {
		changeType(topic_number + 'option', 'topicType' + topic_number);
	});
	$(topicHtml).find('#option-container').attr('id', topic_number + 'option');
	$(topicHtml).find('#option_hidden').attr('id', 'option_hidden' + topic_number);
	$(topicHtml).find('#cloneHiddenOption').attr('id', 'clonebtn' + topic_number);
	$(topicHtml).find('#removeHiddenOption').attr('id', 'removebtn' + topic_number);
	$(topicHtml).find('#option-list').attr('id', topic_number + 'option' + 0);

	$(topicHtml).find('#cloneOption').attr('id', topic_number + 'cloneOption' + 0);
	$(topicHtml).find('#removeOption').attr('id', topic_number + 'removeOption' + 0);

	// alert('option_hidden' + topic_number + '_' + topic_number + '_' + topic_number + "option" + 0);
	$(topicHtml).find('#' + topic_number + 'cloneOption' + 0).click(function() {
		var _tem_number = $(this).attr('id').substring(0,1)
		cloneOption('option_hidden' + _tem_number, _tem_number, _tem_number + "option" + 0);
	});
	$(topicHtml).find('#' + topic_number + 'removeOption' + 0).click(function() {
		removeOption(topic_number + "option" + 0);
	});

	$(topicHtml).find('#cloneTopic').attr('id', topic_number + 'cloneTopic');
	$(topicHtml).find('#removeTopic').attr('id', topic_number + 'removeTopic');
	$(topicHtml).find('#' + topic_number + 'cloneTopic').click(function() {
		addTopic(correntIndex);
	});
	$(topicHtml).find('#' + topic_number + 'removeTopic').click(function() {
		removeTopic(correntIndex);
	});
	$('#' + id).after(topicHtml);
	addTopicIndexToArray(id, topic_number);
	resetTopicIndex();
}

function addTopicIndexToArray(currentIndex, newIndex) {
	var newTopicIndexArray = new Array();
	for(var i=0; i<topic_index.length; i++) {
		if(topic_index[i] == currentIndex) {
			newTopicIndexArray.push(topic_index[i]);
			newTopicIndexArray.push(newIndex);
		} else {
			newTopicIndexArray.push(topic_index[i]);
		}
	}
	topic_index = newTopicIndexArray;
}

function removeTopicIndexToArray(currentIndex) {
	var newTopicIndexArray = new Array();
	for(var i=0; i<topic_index.length; i++) {
		if(topic_index[i] != currentIndex) {
			newTopicIndexArray.push(topic_index[i]);
		}
	}
	topic_index = newTopicIndexArray;
}

function changeType(optionId, typeName) {
	var type = $('[name="' + typeName + '"]').val();
	var id = optionId.substring(0, 1);
	var newhtml = '';
	$('#' + optionId).empty();
	if(type == 0 || type == 1) {
		newhtml = option_0_title + option_0;
	} else if(type == 2) {

	} else if(type == 3) {
		newhtml = option_3_title + option_3;
	} else if(type == 4) {
		newhtml = option_4_title + option_4;
	} else if(type == 5) {
		newhtml = option_5_title + option_5;
	} else if(type == 6) {
		newhtml = option_6_title + option_6;
	}
	if(type != 2) {
		$('#' + optionId).append(newhtml);
		$('#' + optionId).find('#option_hidden').attr('id', 'option_hidden' + id);
		$('#' + optionId).find('#cloneHiddenOption').attr('id', 'clonebtn' + id);
		$('#' + optionId).find('#removeHiddenOption').attr('id', 'removebtn' + id);
		$('#' + optionId).find('#option-list').attr('id', id + 'option' + 0);
		cloneOption('option_hidden' + id , id, id + 'option' + 0);
	}
}


function savePaper() {
	var checkin = true;

	var title = $('#title').val();
	if(!title) {
		alert('标题不能为空！');
		return;
	}
	var desc = $('#desc').val();

	for(var i=0; i<topic_index.length; i++) {
		var topicImg = $('#topicImg' + topic_index[i]).val();

		var topicTitle = $('#topicTitle' + topic_index[i]).val();
		var type = $('[name="topicType' + topic_index[i] + '"]').val();
		if(!topicTitle) {
			checkin = false;
			topics = new Array();
			alert('题目不能为空！');
			return;
		}
		var topic = {
			tdesc: topicTitle,
			ttype: type,
			timg: topicImg
		}
		if(type==0 || type==1 || type==5 || type==6) {
			var options = new Array();
			var optionImg = $('#' + topic_index[i] + 'option').find('.optionImg');

			var option = $('#' + topic_index[i] + 'option').find('.setInput1');

			$.each(option, function(i, item) {
				if(i>0) {
					if(!item.value) {
						topics = new Array();
						alert('选项文字不能为空！');
						checkin = false;
						return;
					}
					var imgurl = '';
					if(optionImg[i] && optionImg[i].value) {
						imgurl = optionImg[i].value;
					}
					var option = {
						odesc: item.value,
						ocount: 0,
						oimg: imgurl
					};
					options.push(option);
				}
			});
			topic.options = options;
		} else if(type==3) {
			var options = new Array();
			var option = $('#' + topic_index[i] + 'option').find('.topic-option-fill-desc');
			$.each(option, function(i, item) {
				if(i>0) {
					if(!item.value) {
						topics = new Array();
						checkin = false;;
						alert('填空文字说明不能为空！');
						return 
					}
					var option = {
						odesc: item.value,
						ocount: 0
					};
					options.push(option);
				}
			});
			topic.options = options;
		} else if(type==4) {
			var options = new Array();
			var option = $('#' + topic_index[i] + 'option').find('.topic-option-table');
			var optionVal = $('#' + topic_index[i] + 'option').find('.topic-option-value');
			$.each(option, function(i, item) {
				if(i>0) {
					if(!item.value) {
						topics = new Array();
						checkin = false;;
						alert('填空文字说明不能为空！');
						return
					}
					var option = {
						odesc: item.value,
						point: optionVal[i].value,
						ocount: 0
					};
					options.push(option);
				}
			});
			topic.options = options;
		}
		topics.push(topic);
	}
	
	if(checkin) {
		console.log(topics);
		$.ajax({
		url: host + '/api/a/updatePaperTopic',
		type: "POST",
		dataType: "json",
		data: {token: token, id: id, topic: JSON.stringify(topics), format: 0, title: title, desc: desc},
		cache: false,
		success: function(result) {
			if (result.state == 200) {
				alert('修改成功！');
				location.href='paper-list.html';
			} else {
				alert(result.data.error);
			}
		},
		error: function(XMLHttpRequest, textStatus, errorThrown) {
												
      	}
	});
	}
	
}

function resetTopicIndex() {
	var startIndex = 1;
	for(var i=0; i<topic_index.length; i++) {
		var topicTitle = $('#topicTitle' + topic_index[i]).val();
		var reg = new RegExp("^[0-9]*$");
		var endIndex = 1;
		for(var p=1; p<4; p++) {
			if(topicTitle.length >= p && !reg.test(topicTitle.substring(0, p))){
				endIndex = p-1;
				break;
			}
		}
		$('#topicTitle' + topic_index[i]).val(startIndex + topicTitle.substring(endIndex));
		startIndex++;
	}
}


var option_0_title = '<div class="setName">设置选项</div>';
var option_0 = '<div id="option_hidden" class="setOption clearfix" style="display: none;" >' +
					'<input type="text" class="setInput1">' +

					//todo
					'<input type="hidden" class="optionImg" />' +

					'<button class="uploadImg"><i class="OImg"></i>上传图片</button>' +
					'<button class="addIssue" id="cloneHiddenOption">＋新增选项</button>' +
					'<div class="delectIssue" id="removeHiddenOption">删除此选项</div>' +
				'</div>' +			
				'<div id="option-list">' +
				'</div>';

var option_3_title =  '<div class="setName">填空文字说明</div>';
var option_3 = '<div id="option_hidden" class="setOption clearfix" style="display: none;" >' +
					'<input type="text" class="setInput1 topic-option-fill-desc">' +
					'<div class="underline"></div>' +
					'<button class="addIssue" id="cloneHiddenOption">＋新增选项</button>' +
					'<div class="delectIssue" id="removeHiddenOption">删除此选项</div>' +
				'</div>' +			
				'<div id="option-list">' +
				'</div>';

var option_4_title = '<div class="setName">设置选项<span class="scoreName">分数</span></div>';
var option_4 = '<div id="option_hidden" class="setOption clearfix" style="display: none;" >' +
					'<input type="text" class="setInput1 topic-option-table">' +
					'<input type="text" class="score topic-option-value">' +
					'<button class="addIssue" id="cloneHiddenOption">＋新增选项</button>' +
					'<div class="delectIssue" id="removeHiddenOption">删除此选项</div>' +
				'</div>' +			
				'<div id="option-list">' +
				'</div>';
var option_5_title = '<div class="setName">下拉框选择文字说明</div>';
var option_5 = '<div id="option_hidden" class="setOption clearfix" style="display: none;" >' +
					'<input type="text" class="setInput1">' +
					'<button class="addIssue" id="cloneHiddenOption">＋新增选项</button>' +
					'<div class="delectIssue" id="removeHiddenOption">删除此选项</div>' +
				'</div>' +			
				'<div id="option-list">' +
				'</div>';
var option_6_title = '<div class="setName">上传文件描述</div>';
var option_6 = option_0;
</script>
</html>